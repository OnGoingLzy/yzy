(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/shops_selling_This_goods/shops_selling_This_goods"],{"06df":function(t,e,n){"use strict";var s=n("532e"),i=n.n(s);i.a},"0928":function(t,e,n){"use strict";n.r(e);var s=n("7280"),i=n("ba84");for(var o in i)["default"].indexOf(o)<0&&function(t){n.d(e,t,(function(){return i[t]}))}(o);n("06df");var u=n("f0c5"),a=Object(u["a"])(i["default"],s["b"],s["c"],!1,null,null,null,!1,s["a"],void 0);e["default"]=a.exports},"532e":function(t,e,n){},"6f21":function(t,e,n){"use strict";(function(t,s){var i=n("4ea4");Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var o=i(n("2eee")),u=i(n("c973")),a=i(n("24db")),r={data:function(){return{goods:{},choiceBar:"test1",sortRule:"距离",filterRule:{businessUnit:[]},useFilterRule:{businessUnit:[]},useFilter:!1,filterShopList:[],shopsList:[],latitude:null,longitude:null,firstClickLocation:!0}},components:{goodsCard:function(){n.e("components/goods/goods_card").then(function(){return resolve(n("0faa"))}.bind(null,n)).catch(n.oe)},shopCard:function(){n.e("components/shop/shop_card").then(function(){return resolve(n("c757"))}.bind(null,n)).catch(n.oe)}},mounted:function(){this.getShops(102,24)},onLoad:function(t){this.goods=JSON.parse(decodeURIComponent(t.goods))},onUnload:function(){console.log("关闭实时定位"),t.offLocationChange()},computed:{filteredShopsList:function(){var t=this;return 0==this.useFilterRule.businessUnit.length?this.shopsList:this.shopsList.filter((function(e){return t.useFilterRule.businessUnit.some((function(t){return t===e.businessUnitName}))}))}},methods:{resetFilterRule:function(){this.useFilterRule.businessUnit=[],this.filterShopList=this.shopsList},getTagType:function(t){var e=this.useFilterRule.businessUnit.some((function(e){return e===t}));return e?"primary":""},clickBusinessUnit:function(t,e){var n=this.useFilterRule.businessUnit.findIndex((function(e){return e===t}));-1===n?this.useFilterRule.businessUnit.push(t):this.useFilterRule.businessUnit.splice(n,1),0!=this.useFilterRule.businessUnit.length?this.useFilter=!0:this.useFilter=!1},createfilterRule:function(t){var e=new Set;t.forEach((function(t){e.add(t.businessUnitName)})),this.filterRule.businessUnit=Array.from(e)},toGoodsDetails:function(e,n){console.log(e),t.navigateTo({url:"/pages/goods_details/goods_details?goods="+encodeURIComponent(JSON.stringify(e))+"&shop="+encodeURIComponent(JSON.stringify(n))})},selectBar:function(e,n){console.log(e);var s=this;"test4"!=e&&(this.choiceBar=e);var i=this.sortRule;return"test1"==e?(this.sortRule="距离",void(this.firstClickLocation?t.startLocationUpdate({success:function(e){console.log("startLocationUpdate用户开启使用小程序期间位置权限:",e),t.onLocationChange((function(t){s.latitude=t.latitude,s.longitude=t.longitude,s.shopsList.forEach((function(t){t.distance=s.calculateDistance(t.latitude,t.longitude)})),s.firstClickLocation=!1,s.sortShopsList(s.sortRule)}))},fail:function(e){console.log("startLocationUpdate获取当前位置失败",e),t.showModal({title:"授权",content:"需要授权才能获取位置信息",success:function(t){if(t.confirm)s.authVerification();else if(t.cancel)return void s.selectBar("test0","")}})}}):s.sortShopsList(s.sortRule))):("test2"==e&&(this.sortRule="库存"),"test3"==e&&"price"==n?("价格升序"==i&&"价格降序"==i||(this.sortRule="价格降序"),"价格升序"==i&&(this.sortRule="价格降序"),"价格降序"==i&&(this.sortRule="价格升序"),void this.sortShopsList(this.sortRule)):("test4"==e&&this.$refs.popup.open("right"),"test0"==e&&(this.sortRule="默认"),this.sortShopsList(this.sortRule),void t.hideLoading()))},authVerification:function(){var e=this,n=this;t.getSetting({success:function(t){t.authSetting["scope.userLocation"]?n.selectBar("test1",""):void 0===t.authSetting["scope.userLocation"]?(console.log("没有授权"),e.handleOpenSetting()):e.handleOpenSetting()}})},handleOpenSetting:function(){var e=this;s.openSetting({success:function(n){console.log("定位 openSetting",n),n.authSetting["scope.userLocation"]?e.selectBar("test1",""):(t.showToast({title:"授权失败",icon:"none"}),e.selectBar("test0",""))}})},sortShopsList:function(e){"价格降序"==e&&this.shopsList.sort((function(t,e){return t.price-e.price})),"价格升序"==e&&this.shopsList.sort((function(t,e){return e.price-t.price})),"库存"!=e&&"默认"!=e||this.shopsList.sort((function(t,e){return e.inventory-t.inventory})),"距离"==e&&(this.shopsList.sort((function(t,e){return t.distance-e.distance})),t.hideLoading())},calculateDistance:function(t,e){var n=this.degreesToRadians(t-this.latitude),s=this.degreesToRadians(e-this.longitude),i=Math.sin(n/2)*Math.sin(n/2)+Math.cos(this.degreesToRadians(this.latitude))*Math.cos(this.degreesToRadians(t))*Math.sin(s/2)*Math.sin(s/2),o=2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)),u=6371*o;return u.toFixed(2)},degreesToRadians:function(t){return t*(Math.PI/180)},getShops:function(e,n){var s=this;return(0,u.default)(o.default.mark((function i(){var u,r;return o.default.wrap((function(i){while(1)switch(i.prev=i.next){case 0:return s.latitude=n,s.longitude=e,console.log(s.latitude),t.showLoading({title:"搜索中.."}),s,console.log("查询门店"),"/api/shop/searchShops","POST",u={goods_json:s.goods,latitude:n,longitude:e,goodsId:s.goods.goodsId},i.prev=9,i.next=12,(0,a.default)("yzy_app","/api/shop/searchShops","POST",u);case 12:r=i.sent,console.log(r),99==r.code?(s.shopsList=r.data.data,s.createfilterRule(r.data.data),s.selectBar("test1",""),setTimeout((function(){t.hideLoading()}),1e3)):t.hideLoading(),i.next=20;break;case 17:i.prev=17,i.t0=i["catch"](9),t.hideLoading();case 20:case"end":return i.stop()}}),i,null,[[9,17]])})))()},getUserLocation:function(){console.log("获取位置");var e=this;t.getLocation({type:"gcj02",success:function(t){console.log(t),e.getShops(t.longitude,t.latitude)},fail:function(t){}})}}};e.default=r}).call(this,n("543d")["default"],n("bc2e")["default"])},7280:function(t,e,n){"use strict";n.d(e,"b",(function(){return i})),n.d(e,"c",(function(){return o})),n.d(e,"a",(function(){return s}));var s={uniPopup:function(){return n.e("uni_modules/uni-popup/components/uni-popup/uni-popup").then(n.bind(null,"0336"))},uniTag:function(){return n.e("uni_modules/uni-tag/components/uni-tag/uni-tag").then(n.bind(null,"ccec"))}},i=function(){var t=this,e=t.$createElement,n=(t._self._c,t.__map(t.filterRule.businessUnit,(function(e,n){var s=t.__get_orig(e),i=t.getTagType(e);return{$orig:s,m0:i}})));t.$mp.data=Object.assign({},{$root:{l0:n}})},o=[]},a538:function(t,e,n){"use strict";(function(t,e){var s=n("4ea4");n("7711");s(n("66fd"));var i=s(n("0928"));t.__webpack_require_UNI_MP_PLUGIN__=n,e(i.default)}).call(this,n("bc2e")["default"],n("543d")["createPage"])},ba84:function(t,e,n){"use strict";n.r(e);var s=n("6f21"),i=n.n(s);for(var o in s)["default"].indexOf(o)<0&&function(t){n.d(e,t,(function(){return s[t]}))}(o);e["default"]=i.a}},[["a538","common/runtime","common/vendor"]]]);