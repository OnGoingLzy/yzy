(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/confirm_order/confirm_order"],{258:function(e,t,n){"use strict";(function(e,t){var o=n(4);n(26);o(n(25));var s=o(n(259));e.__webpack_require_UNI_MP_PLUGIN__=n,t(s.default)}).call(this,n(1)["default"],n(2)["createPage"])},259:function(e,t,n){"use strict";n.r(t);var o=n(260),s=n(262);for(var r in s)["default"].indexOf(r)<0&&function(e){n.d(t,e,(function(){return s[e]}))}(r);n(265);var a,i=n(72),c=Object(i["default"])(s["default"],o["render"],o["staticRenderFns"],!1,null,null,null,!1,o["components"],a);c.options.__file="pages/confirm_order/confirm_order.vue",t["default"]=c.exports},260:function(e,t,n){"use strict";n.r(t);var o=n(261);n.d(t,"render",(function(){return o["render"]})),n.d(t,"staticRenderFns",(function(){return o["staticRenderFns"]})),n.d(t,"recyclableRender",(function(){return o["recyclableRender"]})),n.d(t,"components",(function(){return o["components"]}))},261:function(e,t,n){"use strict";var o;n.r(t),n.d(t,"render",(function(){return s})),n.d(t,"staticRenderFns",(function(){return a})),n.d(t,"recyclableRender",(function(){return r})),n.d(t,"components",(function(){return o}));try{o={uniDataSelect:function(){return Promise.all([n.e("common/vendor"),n.e("uni_modules/uni-data-select/components/uni-data-select/uni-data-select")]).then(n.bind(null,632))},uniIcons:function(){return Promise.all([n.e("common/vendor"),n.e("uni_modules/uni-icons/components/uni-icons/uni-icons")]).then(n.bind(null,510))},uniPopup:function(){return n.e("uni_modules/uni-popup/components/uni-popup/uni-popup").then(n.bind(null,525))}}}catch(i){if(-1===i.message.indexOf("Cannot find module")||-1===i.message.indexOf(".vue"))throw i;console.error(i.message),console.error("1. 排查组件名称拼写是否正确"),console.error("2. 排查组件是否符合 easycom 规范，文档：https://uniapp.dcloud.net.cn/collocation/pages?id=easycom"),console.error("3. 若组件不符合 easycom 规范，需手动引入，并在 components 中注册该组件")}var s=function(){var e=this,t=e.$createElement,n=(e._self._c,"微信医保支付"==e.selectPayValue?e.__map(e.persons,(function(t,n){var o=e.__get_orig(t),s="微信医保支付"!=e.selectPayValue||"本人"==t.relationship?e.calculateAge(t.birthday):null;return{$orig:o,m0:s}})):null),o=e.distance.toFixed(2),s=e.shippingFee.toFixed(2),r=Number(e.totalPrice).toFixed(2),a=e.selectRange.length;e._isMounted||(e.e0=function(t,n,o){var s=arguments[arguments.length-1].currentTarget.dataset,r=s.eventParams||s["event-params"];n=r.index,o=r.person;e.selectPersonIndex=n,e.selectPersonId=o.id}),e.$mp.data=Object.assign({},{$root:{l0:n,g0:o,g1:s,g2:r,g3:a}})},r=!1,a=[];s._withStripped=!0},262:function(e,t,n){"use strict";n.r(t);var o=n(263),s=n.n(o);for(var r in o)["default"].indexOf(r)<0&&function(e){n.d(t,e,(function(){return o[e]}))}(r);t["default"]=s.a},263:function(e,t,n){"use strict";(function(e){var o=n(4);Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var s=o(n(30)),r=o(n(11)),a=o(n(32)),i=o(n(33)),c=o(n(264));function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){(0,r.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var d=function(){n.e("components/user/select_user_location").then(function(){return resolve(n(648))}.bind(null,n)).catch(n.oe)},p={components:{selectUserLocation:d},data:function(){return{validSubmit:!0,selectValue:0,selectRange:[{value:0,text:"请选择",price:999,caution:"无caution"}],selectPayValue:"微信支付",selectPayRange:[{value:"微信支付",text:"微信支付"}],shops:[],totalPrice:0,selectedAddress:{name:"",phone:"",province:"",city:"",district:"",address:"请点击此处选择收货地址"},shippingFee:0,distance:0,checkboxSelected:!1,totalNum:0,list:[],selectedList:[],isEnableClick:!0,popup:!0,locationId:null,memo:"",realTimePricing:[],canNext:!0,priceMatch:!0,allMatch:!0,defaultPic:"http://images.yndzyf.com/getimage.ashx?mlszh=17700932",feeOrigin:[],selectText:"请点击此处选择...",cautionText:"",isShopping:null,businessHours:"",coldFlag:null,showSelector:!1,MedicarePaymentFlag:!1,persons:[],selectPersonId:null,selectPersonIndex:null}},onShow:function(){this.getAddressList(),this.getGoodsUser()},methods:{checkPayTypeChange:function(){if("微信医保支付"==this.selectPayValue&&(null!=this.persons||0!=this.persons.length)){var t=this.persons.findIndex((function(e){return"本人"===e.relationship}));-1!==t?(this.selectPersonIndex=t,this.selectPersonId=this.persons[t].id):(this.selectPersonIndex=null,this.selectPersonId=null,e.$showMsg("请选择'本人'作为用药人!",3e3))}},checkPerson:function(){e.navigateTo({url:"../goods_user/goods_user?openAddUser=true"})},getGoodsUser:function(){var t=this;return(0,a.default)(s.default.mark((function n(){var o,r,a,c,l;return s.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return o="/api/user/getGoodsUser",r="POST",a={openid:e.getStorageSync("openid"),phone:e.getStorageSync("phone")},n.prev=3,n.next=6,(0,i.default)("yzy_app",o,r,a);case 6:c=n.sent,console.log(c),99==c.code?(t.persons=c.data.data,null==t.persons&&0==t.persons.length||(t.persons.sort((function(e,t){return"本人"===e.relationship&&"本人"!==t.relationship?-1:"本人"!==e.relationship&&"本人"===t.relationship?1:"本人"===e.relationship&&"本人"===t.relationship?e.id-t.id:0})),l=t.persons.findIndex((function(e){return"本人"===e.relationship})),-1!==l?(t.selectPersonIndex=l,t.selectPersonId=t.persons[l].id):t.persons.length),t.checkPayTypeChange()):e.$showMsg(c.msg,3e3),n.next=14;break;case 11:n.prev=11,n.t0=n["catch"](3),e.$showMsg(n.t0,3e3);case 14:case"end":return n.stop()}}),n,null,[[3,11]])})))()},calculateAge:function(e){var t=new Date(e.substr(0,4),e.substr(4,2)-1,e.substr(6,2)),n=new Date,o=n-t,s=Math.floor(o/31536e6);return s},turntypeToDefault:function(){this.cautionText="",this.selectValue=0,this.selectText="请点击此处选择...",this.shippingFee=0,this.calcTotalPrice()},openSelectType:function(){this.$refs.popupShipping.open("center")},checkType:function(e){var t=this;this.cautionText=e.caution,this.selectValue=e.value,this.selectText=e.text,this.feeOrigin.forEach((function(e){e.type===t.selectText&&(t.shippingFee=e.Fee)})),this.calcTotalPrice(),this.$refs.popupShipping.close()},showImg:function(t){e.previewImage({urls:[t],longPressActions:{itemList:["发送给朋友","保存图片","收藏"],success:function(e){},fail:function(e){console.log(e.errMsg)}}})},goToShop:function(t){e.navigateTo({url:"/pages/shop_certificate/shop_certificate?shopName="+encodeURIComponent(JSON.stringify(t.shopName))+"&shopId="+encodeURIComponent(JSON.stringify(t.shopId))})},fatherMethods:function(e){console.log("父组件方法",e),this.addOver(e)},addOver:function(e){this.$refs.popup.close()},submitOrder:function(){var t=this;e.requestSubscribeMessage({tmplIds:["JZGbfSSv0-jB5yS4GObkqD0TUrPqDdAbalAcz70xjZg"],success:function(e){console.log(e)}}),this.checkboxSelected?""!==this.selectText&&"请点击此处选择..."!==this.selectText?"请点击此处选择收货地址"!==this.selectedAddress.address?Number(this.totalPrice)!==Number(this.shippingFee)?(this.validSubmit=!1,e.showLoading({title:"请稍等...",mask:!0}),console.log(this.locationId),this.realTimePricing=this.shops[0].drugs.map((function(e){return{goodsId:e.drugId,goodsOuterId:e.drugId,shopId:t.shops[0].shopId}})),this.getRealTimePricing()):e.$showMsg("亲，您购买的药品没货了，请联系药房补货",3e3):e.$showMsg("请先选择收货地址再结算",3e3):e.$showMsg("请先选择配送方式再结算",3e3):e.$showMsg("请先阅读并同意《商品验收标准》，谢谢！",3e3)},getRealTimePricing:function(){var t=this;return(0,a.default)(s.default.mark((function n(){var o,r,a,c,l;return s.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return o="/api/Goods/getShopSellGoodsInfo",r="POST",a={Body:JSON.stringify(t.realTimePricing)},n.prev=3,n.next=6,(0,i.default)("yzy_app",o,r,a);case 6:c=n.sent,console.log(c),t.priceMatch=!1,t.canNext=!1,99==c.code?(l=c.data,console.log("比较数据"),console.log(JSON.stringify(l)),console.log(JSON.stringify(t.shops[0])),t.priceMatch=!0,t.canNext=!0,!0===t.priceMatch&&!0===t.canNext?"微信支付"==t.selectPayValue?t.Pay():"微信医保支付"==t.selectPayValue&&t.yinhaiPay():t.validSubmit=!0):(console.log("-99"+c.result),e.$showMsg(c.result,3e3)),n.next=16;break;case 13:n.prev=13,n.t0=n["catch"](3),e.$showMsg(n.t0,3e3);case 16:case"end":return n.stop()}}),n,null,[[3,13]])})))()},updatePriceAndInventoryToYzy:function(e){return(0,a.default)(s.default.mark((function t(){var n,o,r,a;return s.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n="/api/shop/updatePriceAndInventoryToYzy",o="POST",r={realTimePriceArray:e},t.prev=3,t.next=6,(0,i.default)("yzy_app",n,o,r);case 6:a=t.sent,console.log(a),99==a.code?console.log("价格&库存同步成功！"):console.log("-99"+a.result),t.next=14;break;case 11:t.prev=11,t.t0=t["catch"](3),console.log(t.t0);case 14:case"end":return t.stop()}}),t,null,[[3,11]])})))()},yinhaiPay:function(){var t=this;return(0,a.default)(s.default.mark((function n(){var o,r,a,c,l;return s.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return o=t.shops[0].drugs.map((function(e){return{id:e.id,goodsId:e.drugId,num:e.num,price:e.price}})),r="/api/Trade/yinHaiPay",a="POST",c={openid:e.getStorageSync("openid"),shopId:t.shops[0].shopId,goodsList:o,locationId:t.locationId,memo:t.memo,shippingFee:t.shippingFee,type:t.selectText,payType:t.selectPayValue,goodsUserId:t.selectPersonId},n.prev=4,n.next=7,(0,i.default)("yzy_app",r,a,c);case 7:l=n.sent,console.log(l),99==l.code?(e.hideLoading(),e.redirectTo({url:"/subPackage_yinhai/yinhaiPay/yinhaiPay?orderInfo="+encodeURIComponent(JSON.stringify(l.data))})):(e.showToast({icon:"none",title:"创建订单失败:"+l.msg}),t.validSubmit=!0),n.next=17;break;case 12:n.prev=12,n.t0=n["catch"](4),console.log(n.t0),e.showToast({icon:"none",title:"服务器出错了"}),t.validSubmit=!0;case 17:case"end":return n.stop()}}),n,null,[[4,12]])})))()},Pay:function(){var t=this;return(0,a.default)(s.default.mark((function n(){var o,r,a,c,l;return s.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return o=t.shops[0].drugs.map((function(e){return{id:e.id,goodsId:e.drugId,num:e.num,price:e.price}})),r="/api/Trade/wechatPay",a="POST",c={openid:e.getStorageSync("openid"),shopId:t.shops[0].shopId,goodsList:o,locationId:t.locationId,memo:t.memo,shippingFee:t.shippingFee,type:t.selectText},n.prev=4,n.next=7,(0,i.default)("yzy_app",r,a,c);case 7:l=n.sent,console.log(l),99==l.code?(t.requestWxPay(l.data,l.data.main_order_id),e.hideLoading()):e.showToast({icon:"none",title:"创建订单失败"}),n.next=16;break;case 12:n.prev=12,n.t0=n["catch"](4),console.log(n.t0),e.showToast({icon:"none",title:"服务器出错了"});case 16:case"end":return n.stop()}}),n,null,[[4,12]])})))()},requestWxPay:function(t,n){var o=this;e.requestPayment({provider:"wxpay",timeStamp:t.timeStamp,nonceStr:t.nonceStr,package:t.package,signType:t.signType,paySign:t.paySign,success:function(s){console.log("支付成功"),e.showToast({icon:"success",title:"支付成功",mask:!0}),o.testQueryPay(t.out_order_id,n),o.shops=null,e.redirectTo({url:"/pages/payment_success/payment_success"}),o.validSubmit=!0},fail:function(s){console.log("支付失败"),e.showToast({icon:"none",title:"支付失败"}),o.testQueryPay(t.out_order_id,n),e.reLaunch({url:"/pages/user_order/user_order?num=test1"}),o.validSubmit=!0}})},testQueryPay:function(t,n){var o=this;return(0,a.default)(s.default.mark((function r(){var a,c,l,u;return s.default.wrap((function(s){while(1)switch(s.prev=s.next){case 0:return a="/api/example/testQueryPayOrder",c="POST",l={openid:e.getStorageSync("openid"),main_order_id:n,out_order_id:t},s.prev=3,s.next=6,(0,i.default)("yzy_app",a,c,l);case 6:u=s.sent,console.log(u),99==u.code&&(console.log("真实的response.msg"),console.log(u.msg),console.log("operateId："+u.data.operateId),o.uploadOrderToZhyf(u.msg,u.data.operateId),console.log("查询成功并回填数据库成功！")),s.next=14;break;case 11:s.prev=11,s.t0=s["catch"](3),console.log(s.t0);case 14:case"end":return s.stop()}}),r,null,[[3,11]])})))()},uploadOrderToZhyf:function(e,t){return(0,a.default)(s.default.mark((function n(){var o,r,a,i,l;return s.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return o=JSON.parse(e),o.operateId=t,console.log(JSON.stringify(o)),r="/api/Zhyf/makeAccountForOuterOrder",a="POST",i=JSON.stringify(o),n.prev=6,console.log(i),n.next=10,(0,c.default)("yzy_app",r,a,i);case 10:l=n.sent,console.log(l),99==l.code&&console.log("销售记录上传智慧药房成功！"),n.next=18;break;case 15:n.prev=15,n.t0=n["catch"](6),console.log(n.t0);case 18:case"end":return n.stop()}}),n,null,[[6,15]])})))()},checkboxChange:function(){this.checkboxSelected=!this.checkboxSelected},openReadText:function(){e.navigateTo({url:"/pages/agreement_order/agreement_order"})},bindTextAreaBlur:function(e){this.memo=e.detail.value,console.log(e.detail.value)},calcTotalPrice:function(){var e=this.shops.map((function(e){return u(u({},e),{},{drugs:e.drugs.map((function(e){return u(u({},e),{},{total:e.num*e.price})}))})})),t=e.map((function(e){return u(u({},e),{},{total:e.drugs.reduce((function(e,t){return e+t.total}),0)})})),n=t.reduce((function(e,t){return e+t.total}),0),o=this.shops.flatMap((function(e){return e.drugs.map((function(e){return e.num}))})),s=o.reduce((function(e,t){return e+t}),0);console.log(this.shippingFee);var r=n+this.shippingFee,a=r.toString(),i=a.match(/^-?\d+(?:\.\d{0,2})?/),c=i?i[0]:"";this.totalPrice=c,this.totalNum=s},getAddressList:function(){var t=this;return(0,a.default)(s.default.mark((function n(){var o,r,a,c;return s.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return o="/api/user/getAddressList",r="POST",a={openid:e.getStorageSync("openid")},n.prev=3,n.next=6,(0,i.default)("yzy_app",o,r,a);case 6:c=n.sent,console.log(c),99==c.code?(console.log("99"+c.result),t.selectedAddress=c.data.data[0],t.selectedAddress.phone=c.data.data[0].tel,t.selectedAddress.address=c.data.data[0].details,console.log(t.selectedAddress)):console.log("-99"+c.result),n.next=14;break;case 11:n.prev=11,n.t0=n["catch"](3),console.log(n.t0);case 14:case"end":return n.stop()}}),n,null,[[3,11]])})))()},showAddFrame:function(){this.$refs.popup.open("center")},getShopShippingFee:function(){var e=this;return(0,a.default)(s.default.mark((function t(){var n,o,r,a,c;return s.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n="/api/shop/getShopShippingFee",o="POST",r={shopId:e.shops[0].shopId,addressId:e.locationId},t.prev=3,t.next=6,(0,i.default)("yzy_app",n,o,r);case 6:a=t.sent,console.log("ShippingFee"),console.log(a),99==a.data.flag?(c=e,e.feeOrigin=a.data.data,e.selectRange=[],e.distance=a.data.distance,e.businessHours=a.data.businessHours,"true"===a.data.isShopping?e.isShopping=!0:e.isShopping=!1,e.feeOrigin.sort((function(e,t){return e.Fee-t.Fee})),e.feeOrigin.forEach((function(t){var n="";"跑腿（第三方）"===t.type?n=e.isShopping?c.businessHours+"内订单，收到订单15分钟内完成打包，并交由跑腿（第三方）配送。":c.businessHours+"外订单，第二天营业开始15分钟内完成打包，并交由跑腿（第三方）配送。":"快递邮寄"===t.type?n=e.isShopping?c.businessHours+"内订单，当天完成发货。":c.businessHours+"外订单，第二天营业开始2小时内完成发货。":"药房自配"===t.type?n=e.isShopping?c.businessHours+"内订单，2小时内完成配送。":c.businessHours+"外订单，第二天营业开始2小时内完成配送。":"到店自取"===t.type&&(n=e.isShopping?c.businessHours+"内订单，药房收到订单后20分钟内完成订单打包，顾客凭订单号到店取药。":c.businessHours+"外订单，第二天营业开始20分钟内完成订单打包，顾客凭订单号到店取药。"),e.selectRange.push({value:t.id,text:t.type,price:"￥"+t.Fee.toFixed(2),caution:n}),n=""})),!0===e.coldFlag&&(e.selectRange=e.selectRange.filter((function(e){return"药房自配"===e.text||"到店自取"===e.text||"请选择"===e.text}))),e.calcTotalPrice()):console.log("-99"+a.data.result),t.next=15;break;case 12:t.prev=12,t.t0=t["catch"](3),console.log(t.t0);case 15:case"end":return t.stop()}}),t,null,[[3,12]])})))()},getGoodsColdFlag:function(){var e=this;return(0,a.default)(s.default.mark((function t(){var n,o,r,a,c;return s.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.shops[0].drugs.map((function(e){return{goodsId:e.drugId}})),o="/api/goods/getGoodsColdFlag",r="POST",a={goodsList:n},t.prev=4,t.next=7,(0,i.default)("yzy_app",o,r,a);case 7:c=t.sent,console.log(c),99==c.data.flag?"y"===c.data.coldFlag?e.coldFlag=!0:e.coldFlag=!1:console.log("-99"+c.msg),t.next=15;break;case 12:t.prev=12,t.t0=t["catch"](4),console.log(t.t0);case 15:case"end":return t.stop()}}),t,null,[[4,12]])})))()}},onLoad:function(e){var t=JSON.parse(decodeURIComponent(e.drug));console.log(t),this.shops=t;var n=this.shops[0].drugs.every((function(e){return"y"==e.healthInsuranceFlag}));n?(this.MedicarePaymentFlag=!0,this.selectPayRange=[{value:"微信支付",text:"微信支付"},{value:"微信医保支付",text:"医保支付"}]):this.MedicarePaymentFlag=!1},created:function(){var t=this;e.$on("pageClosedLocation",(function(e){console.log("pageClosedLocation"),console.log(e),t.selectedAddress.name=e.name,t.selectedAddress.phone=e.tel,t.selectedAddress.address=e.details,t.selectedAddress.city=e.city,t.locationId=e.id,console.log("this.locationId:"+t.locationId),t.turntypeToDefault(),t.getGoodsColdFlag(),t.getShopShippingFee()})),e.$on("addressUpdated",(function(e){t.getAddressList(),console.log("获取地址成功！"),t.$refs.child.getAddressList()})),e.$on("pageClosedAddress",(function(e){t.getAddressList(),console.log("pageClosedAddress: FromSelect"),t.$refs.child.getAddressList()}))},beforeDestroy:function(){e.$off("pageClosedLocation")}};t.default=p}).call(this,n(2)["default"])},265:function(e,t,n){"use strict";n.r(t);var o=n(266),s=n.n(o);for(var r in o)["default"].indexOf(r)<0&&function(e){n.d(t,e,(function(){return o[e]}))}(r);t["default"]=s.a},266:function(e,t,n){}},[[258,"common/runtime","common/vendor"]]]);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/confirm_order/confirm_order.js.map